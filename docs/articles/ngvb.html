<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ngvb">
<title>An introduction to the ngvb package • ngvb</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An introduction to the ngvb package">
<meta property="og:description" content="ngvb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ngvb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/ngvb.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An introduction to the ngvb package</h1>
                        <h4 data-toc-skip class="author">Rafael
Cabral</h4>
            
            <h4 data-toc-skip class="date">2023-05-15</h4>
      
      
      <div class="d-none name"><code>ngvb.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Latent Gaussian models (LGMs) assume that the latent variables <span class="math inline">\(\mathbf{x}^G\)</span> follow a Gaussian random
vector with mean <span class="math inline">\(\mathbf{\mu}\)</span> and
precision matrix <span class="math inline">\(\mathbf{Q}=
\mathbf{\mathbf{D}}^T \mathbf{D}\)</span>. It can be expressed through
<span class="math display">\[\begin{equation}\label{eq:gaussian}
\mathbf{D}(\mathbf{x}^G -\mathbf{\mu})\overset{d}{=} \mathbf{Z},
\end{equation}\]</span> where <span class="math inline">\(\mathbf{Z}\)</span> is a vector of i.i.d. standard
Gaussian variables. Models of this type can be fitted with
<code>inla</code>. The non-Gaussian extension for <span class="math inline">\(\mathbf{x}^G\)</span> consists in replacing the
driving noise distribution: <span class="math display">\[\begin{equation}\label{eq:frame}
\mathbf{D}(\mathbf{x}-\mathbf{\mu})\overset{d}{=} \mathbf{\Lambda},
\end{equation}\]</span> where <span class="math inline">\(\boldsymbol{\Lambda}\)</span> is a vector of
independent and standardized normal-inverse Gaussian (NIG) random
variables that depend on the parameter <span class="math inline">\(\eta\)</span>, which controls the leptokurtosis.
This extension leads to latent non-Gaussian models (LnGMs). The package
<code>ngvb</code> is designed to fit these models. <code>ngvb</code> is
based on a variational Bayes algorithm. It leverages the fact that the
conditioned latent field <span class="math inline">\(\mathbf{x}|\mathbf{V}\)</span> is normally
distributed where <span class="math inline">\(\mathbf{V}\)</span> are
inverse-Gaussian mixing variables that regulate the extra flexibility of
the model.</p>
<p>We assume the user is familiar with the INLA package (<span class="citation">Gómez-Rubio (2020)</span>). Latent non-Gaussian models
are discussed in <span class="citation">Cabral, Bolin, and Rue
(2022)</span>, and a Bayesian implementation of LnGMs in Stan can be
found in <a href="rafaelcabral96.github.io/nigstan/">rafaelcabral96.github.io/nigstan/</a>.
We present next a series of examples on how to use the <code>ngvb</code>
package.</p>
</div>
<div class="section level2">
<h2 id="rw1-model">RW1 model<a class="anchor" aria-label="anchor" href="#rw1-model"></a>
</h2>
<p>Here we fit an RW1 latent process to the <code>jumpts</code> time
series.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ngvb</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: INLA</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loading required package: foreach</span></span>
<span><span class="co">#&gt; Loading required package: parallel</span></span>
<span><span class="co">#&gt; Loading required package: sp</span></span>
<span><span class="co">#&gt; This is INLA_22.06.03 built 2022-06-04 11:18:55 UTC.</span></span>
<span><span class="co">#&gt;  - See www.r-inla.org/contact-us for how to get help.</span></span>
<span><span class="co">#&gt; Loading required package: GIGrvg</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">jumpts</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>The model is the following:</p>
<p><span class="math display">\[
y_i = \sigma_x x_i + \sigma_y \epsilon_i,    
\]</span></p>
<p>where <span class="math inline">\(\epsilon_i\)</span> is standard
Gaussian noise, and <span class="math inline">\(\mathbf{x}=[x_1,\dotsc,x_{100}]^T\)</span> follows
a non-Gaussian RW1 prior, defined by <span class="math inline">\(x_{i}=
x_{i-1} + \Lambda_i(\eta), i=2,\dotsc,100\)</span>, where <span class="math inline">\(\Lambda_i(\eta)\)</span> is normal-inverge
Gaussian (NIG) noise with non-Gaussianity parameter <span class="math inline">\(\eta\)</span> (<span class="math inline">\(\eta=0\)</span> leads to the Gaussian model).</p>
<p>First, we start by fitting a latent Gaussian model (LGM), where the
driving noise of the latent field is normally distributed:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">x</span>,  model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> </span>
<span><span class="va">LGM</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">formula</span>, </span>
<span>                data <span class="op">=</span> <span class="va">jumpts</span>,</span>
<span>                control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We check the adequacy of the latent Gaussian assumption for this
model and data through the <code>ng.check</code> function, which
provides a set of diagnostic tools. It plots <span class="math inline">\(d_i(\mathbf{y}), \ i=1,\dotsc,n\)</span>, the
local increase (for small <span class="math inline">\(\eta\)</span>) in
the Bayes factor (BF) when we make the latent field non-Gaussian. High
values of <span class="math inline">\(d_i(\mathbf{y})\)</span> for a
particular index <span class="math inline">\(i\)</span> indicate that
making the driving noise <span class="math inline">\(\Lambda_i(\eta)\)</span> non-Gaussian increases
the Bayes Factor, and thus indicating the lack of flexibility of the
latent Gaussian assumption at that location. Notice that the two sudden
jumps are detected in the next plot.</p>
<p>It also plots the overall BF sensitivity <span class="math inline">\(s_0(\mathbf{y}) = \sum_i d_i(\mathbf{y})\)</span>
(red line) against its reference distribution. A high mismatch suggests
that there could be non-Gaussian features in the observed data that are
better modelled by an LnGM.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ng.check.html">ng.check</a></span><span class="op">(</span><span class="va">LGM</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: geom_vline(): Ignoring `mapping` because `xintercept` was provided.</span></span>
<span><span class="co">#&gt; $plot.ranking</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plot.ref</span></span>
<span><span class="co">#&gt; $plot.ref[[1]]</span></span></code></pre>
<p><img src="ngvb_files/figure-html/unnamed-chunk-4-2.png" width="672"></p>
<p>The diagnostic plots suggest we could benefit from fitting an LnGM.
Next, we consider the non-Gaussian version of the previous LGM model,
where the latent field is driven by NIG noise. We use the output of the
<code>inla</code> function <code>LGM</code> as the input of the
<code>ngvb</code> function. By default, the leptokurtosis parameter
<span class="math inline">\(\eta\)</span> has an exponential prior with
rate parameter equal to 1. This can be changed with the argument
<code>alpha.eta</code>. Run <code><a href="../reference/ngvb.html">?ngvb</a></code> to see the other
arguments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LnGM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ngvb.html">ngvb</a></span><span class="op">(</span>fit <span class="op">=</span> <span class="va">LGM</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Warning: You need to add log(|D|) to mll: check inla.doc(generic0)"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 1 -----------oO0</span></span>
<span><span class="co">#&gt; Initial value of eta: 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 2 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 4.878</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 3 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 3.952</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 4 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 3.423</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 5 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 3.06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 6 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 2.747</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 7 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 2.616</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 8 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 2.476</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 9 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 2.427</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 10 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 2.398</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  0Oo----------- Maximum number of iterations reached -----------oO0</span></span></code></pre></div>
<p><code>LnGM</code> is an S4 object of class <code>ngvb.list</code>
containing the outputs, which can be accessed with
<code>LnGM@...</code>. Available methods are <code>summary</code>,
<code>print</code>, <code>plot</code>, <code>fitted</code>, and
<code>simulate</code>. To read the help functions, run:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#?`summary,ngvb.list-method`</span></span>
<span><span class="co">#?`print,ngvb.list-method`</span></span>
<span><span class="co">#?`plot,ngvb.list,missing-method`</span></span>
<span><span class="co">#?`fitted,ngvb.list-method`</span></span>
<span><span class="co">#?`simulate,ngvb.list-method`</span></span></code></pre></div>
<p>We can see in <code>plot(LnGM)</code> that the two jump locations
were picked up by the mixing variables <span class="math inline">\(V\)</span> (which add more flexibility on those
locations), and the evolution of the parameter <span class="math inline">\(\eta\)</span> seems to indicate convergence.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-7-1.png" width="672"><img src="ngvb_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
<p><code>LnGM@LGM</code> contains the inla object containing summaries
and marginals of the LGM approximation of <span class="math inline">\((x,\theta)\)</span> for the last iteration. We
show next the Bayes factor:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">@</span><span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.760063e+15</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="random-slople-random-intercept-model-several-model-components">Random slople, random intercept model (several model
components)<a class="anchor" aria-label="anchor" href="#random-slople-random-intercept-model-several-model-components"></a>
</h2>
<p>We fit here growth curves from an orthodontic study including several
male and female children at ages 8,10,12, and 14. For more information
and references, run <code><a href="https://amices.org/mice/reference/potthoffroy.html" class="external-link">?mice::potthoffroy</a></code>. Next, we show a
Trellis plot, where female subjects have labels starting with F and male
subjects starting with M.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Orthodont.plot</span>, layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>We use the following linear mixed-effects model to describe the
response growth with age:</p>
<p><span class="math display">\[
y_{i j}=\beta_0+\delta_0 I_i(F) +\left(\beta_1+\delta_1 I_i(F)\right)
t_j + b_{0 i}+b_{1 i} t_j+\epsilon_{i j},
\]</span></p>
<p>where <span class="math inline">\(y_{i j}\)</span> denotes the
response for the <span class="math inline">\(i\)</span>th subject at age
<span class="math inline">\(t_j\)</span>, <span class="math inline">\(i=1, \ldots, 27\)</span> and <span class="math inline">\(j=1, \ldots, 4\)</span> ; <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> denote, respectively, the
intercept and the slope fixed effects for boys; <span class="math inline">\(\delta_0\)</span> and <span class="math inline">\(\delta_1\)</span> denote, respectively, the
difference in intercept and slope fixed effects between girls and boys;
<span class="math inline">\(I_i(F)\)</span> denotes an indicator
variable for females; <span class="math inline">\(\mathbf{b}_i=\left(b_{0 i}, b_{1
i}\right)\)</span> is the random effects vector for the <span class="math inline">\(i\)</span> th subject; and <span class="math inline">\(\epsilon_{i j}\)</span> is the within-subject
error.</p>
<p>The dataset is:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Orthodont</span><span class="op">)</span></span>
<span><span class="co">#&gt;     subject       Female            time          value             tF       </span></span>
<span><span class="co">#&gt;  Min.   : 1   Min.   :0.0000   Min.   :0.00   Min.   :16.50   Min.   :0.000  </span></span>
<span><span class="co">#&gt;  1st Qu.: 7   1st Qu.:0.0000   1st Qu.:0.75   1st Qu.:22.00   1st Qu.:0.000  </span></span>
<span><span class="co">#&gt;  Median :14   Median :0.0000   Median :1.50   Median :23.75   Median :0.000  </span></span>
<span><span class="co">#&gt;  Mean   :14   Mean   :0.4074   Mean   :1.50   Mean   :24.02   Mean   :1.019  </span></span>
<span><span class="co">#&gt;  3rd Qu.:21   3rd Qu.:1.0000   3rd Qu.:2.25   3rd Qu.:26.00   3rd Qu.:2.000  </span></span>
<span><span class="co">#&gt;  Max.   :27   Max.   :1.0000   Max.   :3.00   Max.   :31.50   Max.   :4.000  </span></span>
<span><span class="co">#&gt;     subject2 </span></span>
<span><span class="co">#&gt;  Min.   : 1  </span></span>
<span><span class="co">#&gt;  1st Qu.: 7  </span></span>
<span><span class="co">#&gt;  Median :14  </span></span>
<span><span class="co">#&gt;  Mean   :14  </span></span>
<span><span class="co">#&gt;  3rd Qu.:21  </span></span>
<span><span class="co">#&gt;  Max.   :27</span></span></code></pre></div>
<p>If the random effects have a normal prior, the previous model is an
LGM that can be fitted in INLA. The random intercept is elicited in
<code>formula</code> by <code>f(subject, model = "iid")</code>, and the
random slopes by <code>f(subject2, time, model = "iid")</code>. The
covariates <code>subject1</code> and <code>subject2</code> are the same
since the f()-terms in INLA should depend on the unique names of the
covariates.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">value</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">Female</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">tF</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">subject</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">subject2</span>, <span class="va">time</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">LGM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">formula</span>,</span>
<span>            data <span class="op">=</span> <span class="va">Orthodont</span>,</span>
<span>            control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now run the <code>ng.check</code> function to generate diagnostic
plots regarding the latent Gaussianity assumption.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ng.check.html">ng.check</a></span><span class="op">(</span><span class="va">LGM</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: geom_vline(): Ignoring `mapping` because `xintercept` was provided.</span></span>
<span><span class="co">#&gt; geom_vline(): Ignoring `mapping` because `xintercept` was provided.</span></span>
<span><span class="co">#&gt; $plot.ranking</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plot.ref</span></span>
<span><span class="co">#&gt; $plot.ref[[1]]</span></span></code></pre>
<p><img src="ngvb_files/figure-html/unnamed-chunk-12-2.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plot.ref[[2]]</span></span></code></pre>
<p><img src="ngvb_files/figure-html/unnamed-chunk-12-3.png" width="672"></p>
<p>The last two plots do not show a large mismatch between <span class="math inline">\(s_0(\mathbf{y})\)</span> and its reference
distribution. The sensitivity measures of the fixed effects relative to
the latent Gaussianity assumption for the random intercepts (subject)
and random slopes (subject2) is shown next. These are small compared to
the posterior standard deviation of the fixed effects.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check.list</span><span class="op">$</span><span class="va">sens.fixed.matrix</span></span>
<span><span class="co">#&gt;            (Intercept)        Female          time           tF</span></span>
<span><span class="co">#&gt; subject  -6.467191e-01  8.005355e-01 -4.748893e-05 1.165662e-04</span></span>
<span><span class="co">#&gt; subject2 -9.455233e-11 -2.395009e-07 -2.940273e-07 2.397182e-07</span></span></code></pre></div>
<p>However, for illustration purposes, we still fit an LnGM. We consider
the prior random effects to be distributed according to long-tailed NIG
variables to accommodate possible outliers in the intercepts and
slopes.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LnGM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ngvb.html">ngvb</a></span><span class="op">(</span><span class="va">LGM</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 1 -----------oO0</span></span>
<span><span class="co">#&gt; Initial value of eta: 0.5 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 2 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.302 0.13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 3 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.351 0.152</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 4 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.401 0.151</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 5 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.388 0.152</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 6 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.391 0.151</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  0Oo----------- Convergence achieved -----------oO0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-14-1.png" width="672"><img src="ngvb_files/figure-html/unnamed-chunk-14-2.png" width="672"><img src="ngvb_files/figure-html/unnamed-chunk-14-3.png" width="672"></p>
<p>For the random slopes (subject2), the posterior means of the mixing
variables <span class="math inline">\(V\)</span> are very close to 1,
and <span class="math inline">\(\eta\)</span> is close to 0, suggesting
that a non-Gaussian model for this component is not necessary.</p>
<p>We show next the Bayes factor:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">@</span><span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.862794</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sar-model-using-manual-configs">SAR model (using manual.configs)<a class="anchor" aria-label="anchor" href="#sar-model-using-manual-configs"></a>
</h2>
<p>Here we demonstrate how to fit LnGM models currently unavailable in
<code>ngvb</code> or <code>inla</code> using the rgeneric functionality
of <code>inla</code> and the <code>manual.configs</code> argument of
<code>ngvb</code>.</p>
<p>We study here areal data, which consists of the number of residential
burglaries and vehicle thefts per thousand households (<span class="math inline">\(y_i\)</span>) in 49 counties of Columbus, Ohio, in
1980. This dataset can be found in the <code>spdep</code> package. We
consider the following model:</p>
<p><span class="math display">\[
y_{i}= \beta_0 + \beta_1 \mathrm{HV}_i + \beta_2 \mathrm{HI}_i
+  \sigma_{\mathbf{x}}x_i + \sigma_{\epsilon}\epsilon_i,  
\]</span></p>
<p>where <span class="math inline">\(\mathrm{HV}_i\)</span> and <span class="math inline">\(\mathrm{HI}_i\)</span> are the average household
value and household income for county <span class="math inline">\(i\)</span>, and <span class="math inline">\(\mathbf{x}\)</span> accounts for structured
spatial effects, while <span class="math inline">\(\epsilon_i
\overset{i.i.d}{\sim} N(0,1)\)</span> is an unstructured spatial
effect.</p>
<p>We consider a simultaneous autoregressive (SAR) model for the
spatially structured effects <span class="math inline">\(\mathbf{x}\)</span>. The Gaussian version of this
model can be built from the following system <span class="math inline">\(\mathbf{D}_{SAR}\mathbf{x} =
\sigma_{\mathbf{x}}\mathbf{Z}\)</span>, where <span class="math inline">\(\mathbf{D}_{SAR}=\mathbf{I}-\rho\mathbf{W}\)</span>.
<span class="math inline">\(\mathbf{W}\)</span> is a row standardized
adjacency matrix and <span class="math inline">\(-1&lt;\rho&lt;1\)</span>. The equivalent model
driven by NIG noise is then <span class="math inline">\(\mathbf{D}_{SAR}\mathbf{x} =
\sigma_{\mathbf{x}}\mathbf{\Lambda}\)</span>, where <span class="math inline">\(\mathbf{\Lambda}\)</span> is i.i.d. standardized
NIG noise.</p>
<p>Gaussian SAR models are not implemented in INLA, so we have to use
the <code>rgeneric</code> or <code>cgeneric</code> functionalities
(<span class="citation">Gómez-Rubio (2020)</span>). We start by loading
and preparing the data.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Required package names</span></span>
<span><span class="va">packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spdep"</span>, <span class="st">"rgdal"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Install packages not yet installed</span></span>
<span><span class="va">installed_packages</span> <span class="op">&lt;-</span> <span class="va">packages</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">installed_packages</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">packages</span><span class="op">[</span><span class="op">!</span><span class="va">installed_packages</span><span class="op">]</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co"># Packages loading</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">packages</span>, <span class="va">library</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">columbus</span><span class="op">)</span></span>
<span><span class="va">data</span>    <span class="op">&lt;-</span> <span class="va">columbus</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CRIME"</span>,<span class="st">"HOVAL"</span>,<span class="st">"INC"</span><span class="op">)</span><span class="op">]</span>       <span class="co"># data</span></span>
<span><span class="va">N</span>       <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>                                   <span class="co"># number of counties</span></span>
<span><span class="va">data</span><span class="op">$</span><span class="va">s</span>  <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span> </span>
<span><span class="va">map</span>     <span class="op">&lt;-</span> <span class="fu">readOGR</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/columbus.shp"</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co">#shape file containing the polygons</span></span>
<span><span class="co">#&gt; OGR data source with driver: ESRI Shapefile </span></span>
<span><span class="co">#&gt; Source: "C:\R\library\spData\shapes\columbus.shp", layer: "columbus"</span></span>
<span><span class="co">#&gt; with 49 features</span></span>
<span><span class="co">#&gt; It has 20 fields</span></span>
<span><span class="co">#&gt; Integer64 fields read as strings:  COLUMBUS_ COLUMBUS_I POLYID</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>We construct now the row standardized adjacency matrix <span class="math inline">\(\mathbf{W}\)</span></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_q</span> <span class="op">&lt;-</span> <span class="fu">poly2nb</span><span class="op">(</span><span class="va">map</span><span class="op">)</span>              <span class="co"># Construct neighbours list from polygon list</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nb_q</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow<span class="op">=</span><span class="va">n</span>, ncol<span class="op">=</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nb_q</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">W</span><span class="op">[</span><span class="va">i</span>,<span class="va">nb_q</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> </span>
<span><span class="op">}</span></span>
<span><span class="va">W</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">W</span>    <span class="co"># Row standardize adjacency matrix </span></span>
<span><span class="va">eigenv</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span><span class="op">$</span><span class="va">values</span>      <span class="co"># Eigenvalues of W. We need them to compute the log-determinant of the nb_q</span></span></code></pre></div>
<p>We now implement the latent process <span class="math inline">\(\mathbf{x}|\mathbf{y},\mathbf{V},\sigma_x,\rho
\sim N(\mathbf{0}, \sigma_x^{-2} \mathbf{D}_{SAR}^{-1}
\text{diag}(\mathbf{V})\mathbf{D}_{SAR}^{-T})\)</span> in
<code>rgeneric</code>. The precision matrix is <span class="math inline">\(\mathbf{Q} = \tau_x \mathbf{D}_{SAR}^T
\text{diag}(\mathbf{V})^{-1}\mathbf{D}_{SAR}\)</span> and it is defined
in the <code>Q</code> function. We consider a <span class="math inline">\(\text{Unif}(0,1)\)</span> prior on <span class="math inline">\(\rho\)</span> and a half-normal prior on <span class="math inline">\(\tau_x\)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">'inla.rgeneric.sar.model'</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">cmd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"graph"</span>, <span class="st">"Q"</span>, <span class="st">"mu"</span>, <span class="st">"initial"</span>, <span class="st">"log.norm.const"</span>,</span>
<span>            <span class="st">"log.prior"</span>, <span class="st">"quit"</span><span class="op">)</span>,</span>
<span>    <span class="va">theta</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">envir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Internal scale is log of precision and log of kappa</span></span>
<span>  <span class="va">interpret.theta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">graph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">Q</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">Q</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="va">param</span> <span class="op">=</span> <span class="fu">interpret.theta</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">rho</span></span>
<span>    <span class="va">prec</span>  <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">prec</span></span>
<span>    </span>
<span>    <span class="va">D</span> <span class="op">=</span> <span class="fu">Diagonal</span><span class="op">(</span><span class="va">n</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">rho</span><span class="op">*</span><span class="va">W</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">prec</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu">Diagonal</span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span><span class="op">/</span><span class="va">V</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">D</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">log.norm.const</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">param</span> <span class="op">=</span> <span class="fu">interpret.theta</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">rho</span></span>
<span>    <span class="va">prec</span>  <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">prec</span></span>
<span>    </span>
<span>    <span class="va">log.det.D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">rho</span><span class="op">*</span><span class="va">eigenv</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">*</span><span class="va">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">prec</span><span class="op">)</span> <span class="op">+</span> <span class="va">log.det.D</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">res</span><span class="op">)</span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span></span>
<span>  <span class="va">log.prior</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">param</span> <span class="op">=</span> <span class="fu">interpret.theta</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">rho</span></span>
<span>    <span class="va">prec</span>  <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">prec</span></span>
<span>    </span>
<span>    <span class="va">tau_prec</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>  </span>
<span>    </span>
<span>    <span class="va">prior.theta1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">tau_prec</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span><span class="op">*</span><span class="va">tau_prec</span><span class="op">*</span><span class="va">prec</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span></span>
<span>    <span class="va">prior.theta2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span>  <span class="va">prior.theta1</span> <span class="op">+</span> <span class="va">prior.theta2</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">initial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">quit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span> <span class="va">theta</span> <span class="op">=</span> <span class="fu">initial</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">cmd</span><span class="op">)</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We now create a function that receives as input the mixing vector
<span class="math inline">\(\mathbf{V}\)</span> and outputs the inla
object. The input should be a list of numeric vectors, where each vector
corresponds to each model component to extend to non-Gaussianity (in
this example, there is just one model component). The argument
<code>control.compute = list(config = TRUE)</code> in the
<code>inla</code> function is required.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inla.fit.V</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/rgeneric.html" class="external-link">inla.rgeneric.define</a></span><span class="op">(</span><span class="va">inla.rgeneric.sar.model</span>, n <span class="op">=</span> <span class="va">N</span>, V <span class="op">=</span> <span class="va">V</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, W <span class="op">=</span> <span class="va">W</span>, eigenv <span class="op">=</span> <span class="va">eigenv</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">CRIME</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">HOVAL</span> <span class="op">+</span> <span class="va">INC</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">s</span>, model <span class="op">=</span> <span class="va">model</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">formula</span>, </span>
<span>              data <span class="op">=</span> <span class="va">data</span>,</span>
<span>              control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If <span class="math inline">\(\mathbf{V}=\mathbf{1}\)</span> then
the latent field is Gaussian and <code>inla.fit.V</code> gives us the
LGM.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LGM</span> <span class="op">&lt;-</span> <span class="fu">inla.fit.V</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in inla.model.properties.generic(inla.trim.family(model), mm[names(mm) == : Model 'rgeneric' in section 'latent' is marked as 'experimental'; changes may appear at any time.</span></span>
<span><span class="co">#&gt;   Use this model with extra care!!! Further warnings are disabled.</span></span>
<span></span>
<span><span class="va">LGM</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                   mean         sd 0.025quant   0.5quant 0.975quant       mode</span></span>
<span><span class="co">#&gt; (Intercept) 60.0654513 6.34655354 46.8598297 60.2593757 72.0097849 60.5304478</span></span>
<span><span class="co">#&gt; HOVAL       -0.3038646 0.09423473 -0.4892529 -0.3039573 -0.1179609 -0.3041503</span></span>
<span><span class="co">#&gt; INC         -0.9481599 0.37259524 -1.6913821 -0.9444518 -0.2239064 -0.9358919</span></span>
<span><span class="co">#&gt;                      kld</span></span>
<span><span class="co">#&gt; (Intercept) 1.869492e-07</span></span>
<span><span class="co">#&gt; HOVAL       1.006507e-08</span></span>
<span><span class="co">#&gt; INC         1.126924e-08</span></span></code></pre></div>
<p>We now define the LnGM in <code>ngvb</code> using the
<code>manual.configs</code> argument. <code>manual.configs</code> should
be a list containing <code>inla.fit.V</code>. It should also include
<code>Dfunc</code> which is a list containing the functions <span class="math inline">\(\mathbf{D}_{SAR}(\boldsymbol{\theta})\)</span> for
each model component, that receive as input all hyperparameters <span class="math inline">\(\boldsymbol{\theta}\)</span> in internal scale,
and outputs <span class="math inline">\(\mathbf{D}_{SAR}(\boldsymbol{\theta})\)</span>.
Finally, <code>manual.configs</code> also needs <code>h</code>, a list
containing all predefined constant vectors (see <span class="citation">Cabral, Bolin, and Rue (2022)</span>) for each model
component.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">D1</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="va">rho</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">3L</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">3L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">prec</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu">Diagonal</span><span class="op">(</span><span class="va">N</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">rho</span><span class="op">*</span><span class="va">W</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">Dfunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">D1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">h</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">manual.configs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inla.fit.V <span class="op">=</span> <span class="va">inla.fit.V</span>, Dfunc <span class="op">=</span> <span class="va">Dfunc</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span></span></code></pre></div>
<p>We run the diagnostic plots first as follows.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">check.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ng.check.html">ng.check</a></span><span class="op">(</span><span class="va">LGM</span>, <span class="va">Dfunc</span>, <span class="va">h</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: geom_vline(): Ignoring `mapping` because `xintercept` was provided.</span></span>
<span><span class="co">#&gt; $plot.ranking</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plot.ref</span></span>
<span><span class="co">#&gt; $plot.ref[[1]]</span></span></code></pre>
<p><img src="ngvb_files/figure-html/unnamed-chunk-22-2.png" width="672"></p>
<p>The last plots identify an outlying county. To fit the LnGM, we now
call <code>ngvb</code>, and analyze the output.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LnGM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ngvb.html">ngvb</a></span><span class="op">(</span>manual.configs <span class="op">=</span> <span class="va">manual.configs</span>, selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>s <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">49</span><span class="op">)</span>,</span>
<span>             iter <span class="op">=</span> <span class="fl">10</span>, d.sampling <span class="op">=</span> <span class="cn">TRUE</span>, n.sampling <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 1 -----------oO0</span></span>
<span><span class="co">#&gt; Initial value of eta: 0.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 2 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.36</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 3 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.541</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 4 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.605</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 5 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.655</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 6 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.666</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 7 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.645</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 8 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.672</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 9 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.681</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 0Oo----------- Iteration 10 -----------oO0</span></span>
<span><span class="co">#&gt; Expectation of eta: 0.687</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  0Oo----------- Convergence achieved -----------oO0</span></span>
<span></span>
<span><span class="va">LnGM</span><span class="op">@</span><span class="va">LGM</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                   mean         sd 0.025quant   0.5quant  0.975quant       mode</span></span>
<span><span class="co">#&gt; (Intercept) 58.2211212 5.38888939 46.9580137 58.4203214 68.29904011 58.7650042</span></span>
<span><span class="co">#&gt; HOVAL       -0.1663135 0.07726016 -0.3180045 -0.1665085 -0.01352487 -0.1668969</span></span>
<span><span class="co">#&gt; INC         -1.1950034 0.30496795 -1.8095714 -1.1893868 -0.61022283 -1.1768686</span></span>
<span><span class="co">#&gt;                      kld</span></span>
<span><span class="co">#&gt; (Intercept) 7.312655e-08</span></span>
<span><span class="co">#&gt; HOVAL       1.080458e-08</span></span>
<span><span class="co">#&gt; INC         2.704894e-08</span></span></code></pre></div>
<p>We can see in <code>plot(LnGM)</code> that more flexibility was added
in 2 counties.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">)</span></span></code></pre></div>
<p><img src="ngvb_files/figure-html/unnamed-chunk-24-1.png" width="672"><img src="ngvb_files/figure-html/unnamed-chunk-24-2.png" width="672"></p>
<p>The Bayes factor is:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LnGM</span><span class="op">@</span><span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">LGM</span><span class="op">$</span><span class="va">mlik</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 111510.8</span></span></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-cabral2022controlling" class="csl-entry">
Cabral, Rafael, David Bolin, and Håvard Rue. 2022. <span>“Controlling
the Flexibility of Non-Gaussian Processes Through Shrinkage
Priors.”</span> <em>arXiv Preprint arXiv:2203.05510</em>.
</div>
<div id="ref-gomez2020bayesian" class="csl-entry">
Gómez-Rubio, Virgilio. 2020. <em>Bayesian Inference with INLA</em>. CRC
Press.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Rafael Cabral.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
